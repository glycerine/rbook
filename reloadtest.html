<!DOCTYPE html>
<html lang="en">

<head>
  <title>Reload test page</title>

    <script type="text/javascript">

      // press A, scroll to bottom. works. browsers are not
      // fighting this like they are the other scroll change.
      // window.addEventListener('keydown', e => {
      //     if (65 === e.keyCode) { // uppercase A
      //         window.scroll(0,99999);              
      //     }
      // }, false);


      function disableScroll() {
          // Get the current page scroll position
          scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,

          // if any scroll is attempted, set this to the previous value
          window.onscroll = function() {
              window.scrollTo(scrollLeft, scrollTop);
          };
      }

      function enableScroll() {
          window.onscroll = function() {};
      }
      
/**
 * Tries to connect to the reload service and start listening to reload events.
 *
 * @function tryConnectToReload
 * @public
 */
function tryConnectToReload(address) {
  var conn = new WebSocket(address);

  conn.onclose = function() {
    setTimeout(function() {
      tryConnectToReload(address);
    }, 2000);
  };

  conn.onmessage = function(evt) {
      appendLog(evt.data);
      
      // If we uncomment this line, then the page will refresh every time a message is received.
      //location.reload()

      // After we return from this callback,
      // the scroll position is moved up from the bottom
      // where we had set it.
  };
}


function scrollToBottom() {
   window.scrollTo(0, document.body.scrollHeight);
}
//history.scrollRestoration = "manual";
//window.onload = scrollToBottom;
//window.onready = scrollToBottom;

      
function appendLog(msg){
    var d  = document.getElementById("log");
    var n  = 1 + (d.children.length -1);
    var n1 = n+1;
    var id  = "log_" + n.toString();
    var id1 = "log_" + n1.toString();

    var didCode = false;
    const update = JSON.parse(msg)
    var newstuff = ''; // '<br /> ';
    if (update.text) {
        newstuff += '['+ n +'] <div id="' + id + '">' + update.text; //  + '<br />';
        didCode = true;
        console.log("we added text")
    }
    if (update.image) {
        if (didCode) {
            n = n1;
            id = id1;
            console.log("id is now id1: ", id1)
        } else {
            console.log("id is still id: ", id)
        }
        newstuff += ' ['+ n +'] <div id="'+ id +'" style="max-width: 800px"><img src="http://rog:8080/images/' + update.image + '" style="max-width:100%;"/></div>';
    }
    //newstuff += '</div>'
    //d.innerHTML += newstuff // refuses to stay at the bottom.
    //d.innerHTML = newstuff + d.innerHTML // hmm. now it stays at the bottom when we scrool to the bottom.
    d.innerHTML = d.innerHTML + newstuff

    //var element = document.getElementById("END_OF_PAGE");
    //element.scrollIntoView(true);

    //window.scroll(0,0);  // works to keep at top
    //window.scroll(0,99999);

    //window.scroll(0,99999);
    //scrollToBottom();
    // try to avoid the bounce in the scrollbar: didn't work
    //disableScroll();
    //setTimeout(function() { console.log("called back!"); enableScroll()}, 20);
    
    // 2 msec isn't long enough to win the fight for
    // the scrollbar position, usually. but 20 msec seems to win it
    // consistently.
    // works!
    //setTimeout(function() { console.log("called back!"); window.scroll(0,99999)}, 20);
    // works too:
    setTimeout(function() { console.log("called back!"); scrollToBottom()}, 20);
/*
    // none of this worked. Well maybe it worked and then the scrollbar instantly bounces back up.
    
    //window.scroll(0,99999);
    var element = document.getElementById("END_OF_PAGE");
    element.scrollIntoView(true);
    //element.focus()
    
    
    //var element = document.getElementById(id);
    //element.scrollIntoView();
    //element.scrollIntoView(false);
    //element.scrollIntoView({block: "end", inline:"end"});
    //window.scrollTo(0, document.body.scrollHeight);
    //const scrollingElement = (document.scrollingElement || document.body);
    //scrollingElement.scrollTop = scrollingElement.scrollHeight;
    //scrollToBottom();

    // try simulating an End key press

    var keyboardEvent = document.createEvent("KeyboardEvent");
    var initMethod = typeof keyboardEvent.initKeyboardEvent !== 'undefined' ?
        "initKeyboardEvent" : "initKeyEvent";


    keyboardEvent[initMethod](
        "keydown", // event type : keydown, keyup, keypress
        true, // bubbles
        true, // cancelable
        window, // viewArg: should be window
        false, // ctrlKeyArg
        false, // altKeyArg
        false, // shiftKeyArg
        false, // metaKeyArg
        35, // keyCodeArg : unsigned long the virtual key code, else 0
        0 // charCodeArgs : unsigned long the Unicode character associated with the depressed key, else 0
    );
    document.dispatchEvent(keyboardEvent);
    
*/    
}

try {
  if (window["WebSocket"]) {
    // The reload endpoint is hosted on a statically defined port.
    try {
      tryConnectToReload("ws://rog:12450/reload");
    }
    catch (ex) {
      // If an exception is thrown, that means that we couldn't connect to to WebSockets because of mixed content
      // security restrictions, so we try to connect using wss.
      tryConnectToReload("wss://rog:12451/reload");
    }
  } else {
    console.log("Your browser does not support WebSockets, cannot connect to the Reload service.");
  }
} catch (ex) {
  console.error('Exception during connecting to Reload:', ex);
}
</script>
</head>

<body>
  <div id="log">Log:</div>

  <br />
  hello
  <br />
  there
  <br />
  people
  <div id="END_OF_PAGE"> ___________END_OF_PAGE_________ </div>
</body>

</html>
