<!DOCTYPE html>
<html lang="en">

<head>
    <title>Reload test page</title>
    <script type="text/javascript">

/**
 * Tries to connect to the reload service and start listening to reload events.
 *
 * @function tryConnectToReload
 * @public
 */
function tryConnectToReload(address) {
  var conn = new WebSocket(address);

  conn.onclose = function() {
    setTimeout(function() {
      tryConnectToReload(address);
    }, 2000);
  };

  conn.onmessage = function(evt) {
      appendLog(evt.data);
      
    // If we uncomment this line, then the page will refresh every time a message is received.
    //location.reload()
  };
}

function scrollToBottom() {
   window.scrollTo(0, document.body.scrollHeight);
}
history.scrollRestoration = "manual";
window.onload = scrollToBottom;

      
function appendLog(msg){
    var d  = document.getElementById("log");
    var n  = 1 + (d.children.length -1);
    var n1 = n+1;
    var id  = "log_" + n.toString();
    var id1 = "log_" + n1.toString();

    var didCode = false;
    const update = JSON.parse(msg)
    var newstuff = '<br /> ';
    if (update.text) {
        newstuff += '['+ n +'] <div id="' + id + '">' + update.text + '<br />'
        didCode = true;
    }
    if (update.image) {
        if (didCode) {
            n = n1;
            id = id1;
        }
        newstuff += ' ['+ n +'] <div id="'+ id +'" style="max-width: 800px"><img src="http://rog:8080/images/' + update.image + '" style="max-width:100%;"/></div>';
    }
    newstuff += '</div>'
    d.innerHTML += newstuff
    //var element = document.getElementById("END_OF_PAGE");
    //element.scrollIntoView(true);
    //element.scrollIntoView(false);
    //element.scrollIntoView({block: "end", inline:"end"});
    //window.scrollTo(0, document.body.scrollHeight);
    //const scrollingElement = (document.scrollingElement || document.body);
    //scrollingElement.scrollTop = scrollingElement.scrollHeight;
    scrollToBottom();
}

try {
  if (window["WebSocket"]) {
    // The reload endpoint is hosted on a statically defined port.
    try {
      tryConnectToReload("ws://rog:12450/reload");
    }
    catch (ex) {
      // If an exception is thrown, that means that we couldn't connect to to WebSockets because of mixed content
      // security restrictions, so we try to connect using wss.
      tryConnectToReload("wss://rog:12451/reload");
    }
  } else {
    console.log("Your browser does not support WebSockets, cannot connect to the Reload service.");
  }
} catch (ex) {
  console.error('Exception during connecting to Reload:', ex);
}
</script>
</head>

<body>
  <div id="log"><span>Log:</span></div>
  <div id="END_OF_PAGE"> ___________END_OF_PAGE_________ </div>
</body>

</html>
